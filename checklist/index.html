<!doctype html>
<html lang="en">
    <head>
        <!-- Required meta tags -->
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

        <!-- Bootstrap CSS -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pretty-checkbox@3.0/dist/pretty-checkbox.min.css"/>
        <link rel="stylesheet" href="style.css"/>
        <title>Las aventuras de Chema</title>
    </head>
    <body>
        <div class="container" style="width:400px !important;">
            <div class="card">
                <div class="card-header">
                    Las aventuras de Chema el ganso
                </div>
                <ul class="list-group">
                    <li class="list-group-item">
                        <div class="pretty p-svg p-curve p-bigger">
                            <input type="checkbox"/>
                            <div class="state p-success">
                                <svg class="svg svg-icon" viewBox="0 0 20 20">
                                    <path d="M7.629,14.566c0.125,0.125,0.291,0.188,0.456,0.188c0.164,0,0.329-0.062,0.456-0.188l8.219-8.221c0.252-0.252,0.252-0.659,0-0.911c-0.252-0.252-0.659-0.252-0.911,0l-7.764,7.763L4.152,9.267c-0.252-0.251-0.66-0.251-0.911,0c-0.252,0.252-0.252,0.66,0,0.911L7.629,14.566z" style="stroke: white;fill:white;"></path>
                                </svg>
                                <label>Avisar a Danny de que se ha roto la lista</label>
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
        <div class="debug">
            <p>Debug</p>

        </div>
        <!-- Optional JavaScript -->
        <!-- jQuery first, then Popper.js, then Bootstrap JS -->
        <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha384-xBuQ/xzmlsLoJpyjoggmTEz8OWUFM0/RC5BsqQBDX2v5cMvDHcMakNTNrHIW2I5f" crossorigin="anonymous"></script>
<!--        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>-->
<!--        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>-->
        <script>
            function addDebug(message){
                $('.debug').append('<p>'+message+'</p>')
            }

            function renderList(checklist) {
                addDebug("render");

                $('ul').empty();

                $.each(sliceRangeToShow(checklist), function (index, element) {
                    $('ul').append(
                        '<li class="list-group-item">' +
                        '<div class="pretty p-svg p-curve p-bigger ' + (element.done ? 'p-toggle' : '') + '">' +
                        '<input type="checkbox"/>' +
                        '<div class="state p-success">' +
                        '<svg class="svg svg-icon" viewBox="0 0 20 20">' +
                        '<path d="M7.629,14.566c0.125,0.125,0.291,0.188,0.456,0.188c0.164,0,0.329-0.062,0.456-0.188l8.219-8.221c0.252-0.252,0.252-0.659,0-0.911c-0.252-0.252-0.659-0.252-0.911,0l-7.764,7.763L4.152,9.267c-0.252-0.251-0.66-0.251-0.911,0c-0.252,0.252-0.252,0.66,0,0.911L7.629,14.566z" style="stroke: white;fill:white;"></path>' +
                        '</svg>' +
                        '<label>' + element.name + '</label>' +
                        '</div>' +
                        '</div></li>');
                })
                addDebug("render acabado");

            }

            function loadChecklist() {
                addDebug("cargando lista");

                // $.getJSON('checklist.json', function (data) {
                $.getJSON('https://jsonblob.com/api/jsonBlob/976d7a58-c283-11ea-ac00-5bb5e6532ca0', function (data) {
                    checklist = data.checklist;
                    addDebug("lista cargada");

                    renderList(checklist);
                });
            }

            function findLastDone(checklist) {
                let found = 0;
                $.each(checklist, function (index, element) {
                    if (element.done === true) {
                        found = index;
                    }
                })

                return found;
            }

            function sliceRangeToShow(checklist) {
                const min = 0;
                const max = checklist.length;
                const itemsShown = itemsToShow ?? 0;

                const pivot = findLastDone(checklist);

                let lower = Math.max(pivot - 1, min);
                let higher = Math.min(pivot + itemsShown - 2, max);
                let difference = higher - lower;

                if (difference - 1 < itemsShown) {
                    //We push up
                    const new_higher = lower + itemsShown;
                    higher = Math.min(new_higher, max)

                    let difference = higher - lower;

                    if (difference - 1 < itemsShown) {
                        //We push down
                        const new_lower = higher - itemsShown;
                        lower = Math.max(new_lower, min)
                    }
                }

                return checklist.slice(lower, higher);
            }
            addDebug("Starting");
            let checklist = [
                {name: "Avisar a Danny de que se ha roto la lista", done: false},
            ]
            const url_string = window.location.href;
            const url = new URL(url_string);
            let itemsToShow = url.searchParams.get("items");
            if (!itemsToShow) {
                itemsToShow = 4
            }
            console.log('items', itemsToShow);
            addDebug("inicializado");

            $(document).ready(function () {
                addDebug("ready");

                $.ajaxSetup({cache: false});
                loadChecklist();
                // Update data every 5 seconds
                const interval = setInterval(function () {
                    loadChecklist();
                }, 5000);

                // Update style every minute
                setTimeout(function () {
                    window.location.href = window.location.href;
                }, 60000);

            })



        </script>
    </body>
</html>
